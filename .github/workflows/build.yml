name: build

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: [self-hosted, linux, x64, docker]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Show runner info
        shell: bash
        run: |
          set -euo pipefail
          uname -a
          id
          docker version
          docker info

      - name: Build Docker image
        shell: bash
        run: |
          set -euo pipefail
          docker build -t dovecot-el10-lua-plugins:ci .

      - name: Build artifacts in container
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACTS_DIR="${RUNNER_TEMP}/artifacts"
          rm -rf "${ARTIFACTS_DIR}"
          mkdir -p "${ARTIFACTS_DIR}"

          docker run --rm \
            -v "${ARTIFACTS_DIR}:/artifacts" \
            dovecot-el10-lua-plugins:ci

          # The build container runs as root and will create root-owned files in
          # the mounted host directory. Fix ownership to the runner user so
          # future job cleanup doesn't fail with EACCES.
          docker run --rm \
            -v "${ARTIFACTS_DIR}:/artifacts" \
            alpine:3.20 \
            sh -lc "chown -R $(id -u):$(id -g) /artifacts"

      - name: Smoke check artifacts
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACTS_DIR="${RUNNER_TEMP}/artifacts"
          test -d "${ARTIFACTS_DIR}" || (echo "Missing artifacts dir: ${ARTIFACTS_DIR}" >&2; exit 1)

          echo "==artifacts tree=="
          find "${ARTIFACTS_DIR}" -maxdepth 3 -type f -print | sort | sed -n '1,200p'

          test -d "${ARTIFACTS_DIR}/plugins" || (echo "Missing ${ARTIFACTS_DIR}/plugins" >&2; exit 1)

          echo "==plugins listing=="
          ls -la "${ARTIFACTS_DIR}/plugins" || true

          # Expect Lua + push-notification related .so outputs
          find "${ARTIFACTS_DIR}/plugins" -maxdepth 1 -type f -name '*push_notification*plugin.so*' | grep -q . \
            || (echo "Missing push_notification plugin artifact" >&2; exit 1)
          find "${ARTIFACTS_DIR}/plugins" -maxdepth 1 -type f -name '*mail*lua*plugin.so*' | grep -q . \
            || (echo "Missing mail_lua plugin artifact" >&2; exit 1)
          find "${ARTIFACTS_DIR}/plugins" -maxdepth 1 -type f \( -name 'libdovecot-lua.so*' -o -name '*lua*.so*' \) | grep -q . \
            || (echo "Missing libdovecot-lua / lua .so artifact" >&2; exit 1)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: artifacts
          path: ${{ runner.temp }}/artifacts/
          if-no-files-found: error

  release:
    needs: build
    if: ${{ startsWith(github.ref, 'refs/tags/') && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: artifacts
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*
